!function(t){function e(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);return t}function n(){this.raw=[],this.length=0}function r(){return"___"+A++}function i(t,e){var n=new Function;n.prototype=e.prototype,t.prototype=new n,t.prototype.constructor=t}function o(t){return I[t]}function s(t){return'"'+t.replace(/\x5C/g,"\\\\").replace(/"/g,'\\"').replace(/\x0A/g,"\\n").replace(/\x09/g,"\\t").replace(/\x0D/g,"\\r")+'"'}function a(t){var e=arguments;return t.replace(/\{([0-9]+)\}/g,function(t,n){return e[n-0+1]})}function p(t){return a('gv({0},["{1}"])',s(t),t.replace(/\[['"]?([^'"]+)['"]?\]/g,function(t,e){return"."+e}).split(".").join('","'))}function h(t){return t.replace(/\$\{([0-9a-z_\.\[\]'"-]+)\}/gi,function(t,e){return p(e)})}function u(t,e,n,r,i,o){for(var s=n.length,a=t.split(e),p=0,h=[],u=0,c=a.length;c>u;u++){var f=a[u];if(u){for(p++;;){var l=f.indexOf(n);if(0>l){h.push(f);break}if(p=r?p-1:0,h.push(p>0?e:"",f.slice(0,l),p>0?n:""),f=f.slice(l+s),0===p)break}0===p&&(i(h.join("")),f&&o(f),h=[])}else o(f)}p>0&&h.length>0&&(o(e),o(h.join("")))}function c(t,e){this.value=t,this.engine=e}function f(t,e){this.value=t,this.engine=e,this.children=[]}function l(t,e){var n=t.stack,r=e?n.find(function(t){return t instanceof e}):n.bottom();if(r){var i;do{if(i=n.top(),!i.autoClose)throw new Error(i.type+" must be closed manually: "+i.value);i.autoClose(t)}while(i!==r)}return r}function d(t,e){if(!/^\s*([a-z0-9_-]+)\s*(\(\s*master\s*=\s*([a-z0-9_-]+)\s*\))?\s*/i.test(t))throw new Error("Invalid "+this.type+" syntax: "+t);if(this.master=RegExp.$3,this.name=RegExp.$1,f.call(this,t,e),e.targets[this.name])throw new Error("Target is exists: "+this.name);this.contents={}}function g(t,e){if(!/^\s*([a-z0-9_-]+)\s*(\(\s*master\s*=\s*([a-z0-9_-]+)\s*\))?\s*/i.test(t))throw new Error("Invalid "+this.type+" syntax: "+t);if(this.master=RegExp.$3,this.name=RegExp.$1,f.call(this,t,e),e.masters[this.name])throw new Error("Master is exists: "+this.name);this.contents={}}function y(t,e){if(!/^\s*([a-z0-9_-]+)\s*$/i.test(t))throw new Error("Invalid "+this.type+" syntax: "+t);this.name=RegExp.$1,f.call(this,t,e)}function v(t,e){if(!/^\s*([a-z0-9_-]+)\s*$/i.test(t))throw new Error("Invalid "+this.type+" syntax: "+t);this.name=RegExp.$1,f.call(this,t,e)}function m(t,e){if(!/^\s*([a-z0-9_-]+)\s*$/i.test(t))throw new Error("Invalid "+this.type+" syntax: "+t);this.name=RegExp.$1,f.call(this,t,e)}function R(t,e){if(!/^\s*([a-z0-9_]+)\s*=(.*)$/i.test(t))throw new Error("Invalid "+this.type+" syntax: "+t);this.name=RegExp.$1,this.expr=RegExp.$2,f.call(this,t,e)}function x(t,e){if(!/^\s*([a-z0-9_-]+)\s*(\((.*)\))?\s*$/i.test(t))throw new Error("Invalid "+this.type+" syntax: "+t);this.name=RegExp.$1,this.args=RegExp.$3,f.call(this,t,e)}function E(t,e){if(!/^\s*([a-z0-9_-]+)\s*(\((.*)\))?\s*$/i.test(t))throw new Error("Invalid "+this.type+" syntax: "+t);this.name=RegExp.$1,this.args=RegExp.$3,f.call(this,t,e)}function w(t,e){if(!/^\s*\$\{([0-9a-z_\.\[\]'"-]+)\}\s+as\s+\$\{([0-9a-z_]+)\}\s*(,\s*\$\{([0-9a-z_]+)\})?\s*$/i.test(t))throw new Error("Invalid "+this.type+" syntax: "+t);this.list=RegExp.$1,this.item=RegExp.$2,this.index=RegExp.$4,f.call(this,t,e)}function $(t,e){f.call(this,t,e)}function C(t,e){$.call(this,t,e)}function b(t,e){f.call(this,t,e)}function _(t,e){L[t]=e,e.prototype.type=t}function O(t){this.options={commandOpen:"<!--",commandClose:"-->",defaultFilter:"html"},this.config(t),this.masters={},this.targets={},this.filters=e({},B)}function z(t,e){function r(){var t,n=f.length;if(n>0&&""!==(t=f.join(""))){var r=new c(t,e);r.beforeAdd(h),p.top().addTextNode(r),f=[]}}function i(t){return t instanceof o}var o,s=e.options.commandOpen,a=e.options.commandClose,p=new n,h={engine:e,targets:[],stack:p},f=[];return u(t,s,a,0,function(t){var n=/^\s*(\/)?([a-z]+)\s*(:(.*))?$/.exec(t);if(n&&(o=L[n[2].toLowerCase()])&&"function"==typeof o)if(r(),n[1]){var u=p.find(i);u&&u.close(h)}else{var c=new o(n[4],e);"function"==typeof c.beforeOpen&&c.beforeOpen(h),c.open(h)}else/^\s*\/\//.test(t)||f.push(s,t,a);o=null},function(t){f.push(t)}),r(),l(h),h.targets}n.prototype={push:function(t){this.raw[this.length++]=t},pop:function(){if(this.length>0){var t=this.raw[--this.length];return this.raw.length=this.length,t}},top:function(){return this.raw[this.length-1]},bottom:function(){return this.raw[0]},find:function(t){for(var e=this.length;e--;){var n=this.raw[e];if(t(n))return n}}};var A=178245,I={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},B={html:function(t){return t.replace(/[&<>"']/g,o)},url:encodeURIComponent,raw:function(t){return t}},D='var r="";',j="r+=",k=";",M="return r;";"undefined"!=typeof navigator&&/msie\s*([0-9]+)/i.test(navigator.userAgent)&&RegExp.$1-0<8&&(D="var r=[],ri=0;",j="r[ri++]=",M='return r.join("");'),c.prototype={getRendererBody:function(){var t=this.engine.options.defaultFilter,e=[];return u(this.value,"${","}",1,function(n){n.indexOf("|")<0&&t&&(n+="|"+t);var r=n.split(/\s*\|\s*/),i=r[0],o="ts(",s=")";0===i.indexOf("*")&&(i=i.slice(1),o=s="");for(var a=[o,p(i),s],u=1,c=r.length;c>u;u++){var f=r[u];/^\s*([a-z0-9_-]+)(\((.*)\))?\s*$/i.test(f)&&(a.unshift('fs["'+RegExp.$1+'"]('),RegExp.$3&&a.push(",",h(RegExp.$3)),a.push(")"))}e.push(j,a.join(""),k)},function(t){e.push(j,s(t),k)}),e.join("")},getContent:function(){return this.value}},f.prototype={addChild:function(t){this.children.push(t)},open:function(t){var e=t.stack.top();this.parent=e,e&&e.addChild(this),t.stack.push(this)},close:function(t){for(;t.stack.pop().constructor!==this.constructor;);},addTextNode:function(t){this.addChild(t)},getRendererBody:function(){for(var t=[],e=this.children,n=0;n<e.length;n++)t.push(e[n].getRendererBody());return t.join("")}};var P='data=data||{};var v={},fs=engine.filters,hg=typeof data.get=="function",gv=function(n,ps){var p=ps[0],d=v[p];if(d==null){if(hg){return data.get(n);}d=data[p];}for(var i=1,l=ps.length;i<l;i++)if(d!=null)d = d[ps[i]];return d;},ts=function(s){if(typeof s==="string"){return s;}if(s==null){s="";}return ""+s;};';i(d,f),i(g,f),i(y,f),i(v,f),i(m,f),i(R,f),i(x,f),i(E,f),i(w,f),i($,f),i(C,$),i(b,f);var F={READING:1,READED:2,APPLIED:3,READY:4};g.prototype.close=g.prototype.autoClose=d.prototype.close=d.prototype.autoClose=function(t){f.prototype.close.call(this,t),this.state=this.master?F.READED:F.APPLIED,t.targetOrMaster=null},d.prototype.applyMaster=g.prototype.applyMaster=function(){if(this.state>=F.APPLIED)return 1;var t=this.engine.masters[this.master];if(t&&t.applyMaster()){this.children=[];for(var e=0,n=t.children.length;n>e;e++){var r=t.children[e];r instanceof v?this.children.push.apply(this.children,(this.contents[r.name]||r).children):this.children.push(r)}return this.state=F.APPLIED,1}},d.prototype.isReady=function(){function t(r){for(var i=0,o=r.children.length;o>i;i++){var s=r.children[i];if(s instanceof m||s instanceof E){var a=e.targets[s.name];n=n&&a&&a.isReady(e)}else s instanceof f&&t(s)}}if(this.state>=F.READY)return 1;var e=this.engine,n=1;return this.applyMaster()?(t(this),n&&(this.state=F.READY),n):void 0},d.prototype.getRenderer=function(){if(this.renderer)return this.renderer;if(this.isReady()){var t=new Function("data","engine",[P,D,this.getRendererBody(),M].join("\n")),e=this.engine;return this.renderer=function(n){return t(n,e)},this.renderer}return null},d.prototype.getContent=function(){if(this.isReady()){for(var t=[],e=this.children,n=0;n<e.length;n++)t.push(e[n].getContent());return t.join("")}return""},d.prototype.open=function(t){l(t),f.prototype.open.call(this,t);var e=this.name;t.targetOrMaster=this,this.state=F.READING,t.engine.targets[e]=this,t.targets.push(e)},g.prototype.open=function(t){l(t),f.prototype.open.call(this,t);var e=this.name;t.targetOrMaster=this,this.state=F.READING,t.engine.masters[e]=this},m.prototype.open=R.prototype.open=E.prototype.open=function(t){var e=t.stack.top();this.parent=e,e.addChild(this)},E.prototype.beforeOpen=m.prototype.beforeOpen=R.prototype.beforeOpen=w.prototype.beforeOpen=x.prototype.beforeOpen=$.prototype.beforeOpen=c.prototype.beforeAdd=function(t){if(!t.stack.bottom()){var e=new d(r(),t.engine);e.open(t)}},E.prototype.close=m.prototype.close=b.prototype.close=R.prototype.close=function(){},m.prototype.getContent=function(){var t=this.engine.targets[this.name];return t.getContent()},m.prototype.getRendererBody=function(){var t=this.engine.targets[this.name];return t.getRendererBody()},E.prototype.getRendererBody=function(){return a("{0}engine.render({2},{{3}}){1}",j,k,s(this.name),h(this.args.replace(/(^|,)\s*([a-z0-9_]+)\s*=/gi,function(t,e,n){return(e||"")+s(n)+":"})))},R.prototype.getRendererBody=function(){return this.expr?a("v[{0}]={1};",s(this.name),h(this.expr)):""},$.prototype.getRendererBody=function(){var t=a("if({0}){{1}}",h(this.value),f.prototype.getRendererBody.call(this)),e=this["else"];return e?[t,a("else{{0}}",e.getRendererBody())].join(""):t},w.prototype.getRendererBody=function(){return a('var {0}={1};if({0} instanceof Array)for (var {4}=0,{5}={0}.length;{4}<{5};{4}++){v[{2}]={4};v[{3}]={0}[{4}];{6}}else if(typeof {0}==="object")for(var {4} in {0}){v[{2}]={4};v[{3}]={0}[{4}];{6}}',r(),p(this.list),s(this.index||r()),s(this.item),r(),r(),f.prototype.getRendererBody.call(this))},x.prototype.getRendererBody=function(){var t=this.args;return a("{2}fs[{5}]((function(){{0}{4}{1}})(){6}){3}",D,M,j,k,f.prototype.getRendererBody.call(this),s(this.name),t?","+h(t):"")},y.prototype.open=function(t){l(t,y),f.prototype.open.call(this,t),t.targetOrMaster.contents[this.name]=this},v.prototype.open=function(t){l(t,v),f.prototype.open.call(this,t)},y.prototype.autoClose=$.prototype.autoClose=f.prototype.close,v.prototype.autoClose=function(t){var e=this.parent.children;e.push.apply(e,this.children),this.children.length=0,this.close(t)},$.prototype.addChild=function(t){var e=this["else"];(e?e.children:this.children).push(t)},C.prototype.open=function(t){var e=new b;e.open(t);var n=l(t,$);n.addChild(this),t.stack.push(this)},b.prototype.open=function(t){var e=l(t,$);e["else"]=this,t.stack.push(e)};var L={};_("target",d),_("master",g),_("content",y),_("contentplaceholder",v),_("import",m),_("use",E),_("var",R),_("for",w),_("if",$),_("elif",C),_("else",b),_("filter",x),O.prototype.config=function(t){e(this.options,t)},O.prototype.compile=O.prototype.parse=function(t){var e=z(t,this);return e.length?this.targets[e[0]].getRenderer():void 0},O.prototype.getRenderer=function(t){var e=this.targets[t];return e?e.getRenderer():void 0},O.prototype.get=function(t){var e=this.targets[t];return e?e.getContent():""},O.prototype.render=function(t,e){var n=this.getRenderer(t);return n?n(e):""},O.prototype.addFilter=function(t,e){"function"==typeof e&&(this.filters[t]=e)};var N=new O;N.Engine=O,"object"==typeof exports&&"object"==typeof module?exports=module.exports=N:"function"==typeof define&&define.amd?define(N):t.etpl=N}(this);